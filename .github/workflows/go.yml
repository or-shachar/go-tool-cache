# This workflow will build a golang project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-go

name: Go

on:
  push:
    branches: [ "main" ]
  pull_request_target:
    types:
      - opened
      - edited
      - reopened
      - synchronize
      - labeled


jobs:

  build:
    runs-on: ubuntu-latest
    name: Build with Go ${{ matrix.go }}
    # Only run if:
    # 1. Push to main branch, OR
    # 2. PR has 'safe-to-test' label, OR
    # 3. Comment contains '/run-tests' and commenter is a maintainer
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request_target' && contains(github.event.pull_request.labels.*.name, 'safe-to-test')) ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '/run-tests') &&
       (github.event.comment.author_association == 'OWNER' ||
        github.event.comment.author_association == 'MEMBER' ||
        github.event.comment.author_association == 'COLLABORATOR'))
    strategy:
      matrix:
        go: [ '1.23', '1.24', '1.25' ]
    steps:
      - name: Get PR branch for comment trigger
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        id: get-pr-comment
        with:
          script: |
            const request = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            }
            core.info(`Getting PR #${request.pull_number} from ${request.owner}/${request.repo}`)
            try {
              const result = await github.rest.pulls.get(request)
              return result.data
            } catch (err) {
              core.setFailed(`Request failed with error ${err}`)
            }

      # Checkout PR code (uses workflow from base branch for security)
      - name: Checkout PR code
        uses: actions/checkout@v4
        if: github.event_name == 'pull_request_target'
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Checkout PR code (from comment)
        uses: actions/checkout@v4
        if: github.event_name == 'issue_comment'
        with:
          ref: ${{ fromJSON(steps.get-pr-comment.outputs.result).head.sha }}

      - name: Checkout code (push to main)
        uses: actions/checkout@v4
        if: github.event_name == 'push'

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go }} 
          check-latest: true

      - name: Build
        run: go build -v ./...

      - name: Test
        run: go test -v ./...

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: v2.6
          args: --timeout 5m
          install-mode: "binary"
